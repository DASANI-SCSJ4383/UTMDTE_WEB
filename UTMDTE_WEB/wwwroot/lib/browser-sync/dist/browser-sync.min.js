/**
 * Minified by jsDelivr using Terser v5.10.0.
 * Original file: /npm/browser-sync@2.27.9/dist/browser-sync.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
"use strict";var hooks=require("./hooks"),asyncTasks=require("./async-tasks"),config=require("./config"),connectUtils=require("./connect-utils"),utils=require("./utils"),logger=require("./logger"),eachSeries=utils.eachSeries,_=require("./lodash.custom"),EE=require("easy-extender"),defaultPlugins={logger:logger,socket:require("./sockets"),"file:watcher":require("./file-watcher"),server:require("./server"),tunnel:require("./tunnel"),"client:script":require("browser-sync-client"),UI:require("browser-sync-ui")},BrowserSync=function(e){var t=this;t.cwd=process.cwd(),t.active=!1,t.paused=!1,t.config=config,t.utils=utils,t.events=t.emitter=e,t._userPlugins=[],t._reloadQueue=[],t._cleanupTasks=[],t._browserReload=!1,t.pluginManager=new EE(defaultPlugins,hooks)};function taskRunner(e){return function(t,n){e.debug("-> {yellow:Starting Step: "+t.step),t.fn(e,(function(o,r){if(o)return n(o);r&&handleOut(e,r);e.debug("+  {green:Step Complete: "+t.step),n()}))}}function handleOut(e,t){t.options&&setOptions(e,t.options),t.optionsIn&&t.optionsIn.forEach((function(t){e.setOptionIn(t.path,t.value)})),t.instance&&Object.keys(t.instance).forEach((function(n){e[n]=t.instance[n]}))}function setOptions(e,t){Object.keys(t).length>1?e.setMany((function(e){Object.keys(t).forEach((function(n){return e.set(n,t[n]),e}))})):Object.keys(t).forEach((function(n){e.setOption(n,t[n])}))}function tasksComplete(e){return function(t){t&&e.logger.setOnce("useLevelPrefixes",!0).error(t.message),e.active=!0,e.events.emit("init",e),e.events.emit("service:running",{options:e.options,baseDir:e.options.getIn(["server","baseDir"]),type:e.options.get("mode"),port:e.options.get("port"),url:e.options.getIn(["urls","local"]),urls:e.options.get("urls").toJS(),tunnel:e.options.getIn(["urls","tunnel"])}),e.callback("ready",null,e),e.cb(null,e)}}BrowserSync.prototype.callback=function(e){var t=this,n=t.options.getIn(["callbacks",e]);_.isFunction(n)&&n.apply(t.publicInstance,_.toArray(arguments).slice(1))},BrowserSync.prototype.init=function(e,t){var n=this;if(n.cb=t||utils.defaultCallback,utils.verifyConfig(e,n.cb))return n._options=e,n.options=e,n.pluginManager.init(),n.logger=n.pluginManager.get("logger")(n.events,n),n.debugger=n.logger.clone({useLevelPrefixes:!0}),n.debug=n.debugger.debug,eachSeries(asyncTasks,taskRunner(n),tasksComplete(n)),this},BrowserSync.prototype.registerPlugin=function(e,t,n){this.pluginManager.registerPlugin(e,t,n),e["plugin:name"]&&this._userPlugins.push(e)},BrowserSync.prototype.getUserPlugin=function(e){var t=this.getUserPlugins((function(t){return t["plugin:name"]===e}));return!(!t||!t.length)&&t[0]},BrowserSync.prototype.getUserPlugins=function(e){var t=this;return e=e||function(){return!0},t.userPlugins=t._userPlugins.filter(e).map((function(e){return{name:e["plugin:name"],active:e._enabled,opts:t.pluginManager.pluginOptions[e["plugin:name"]]}})),t.userPlugins},BrowserSync.prototype.getMiddleware=function(e){var t={connector:connectUtils.socketConnector(this.options)};if(e in t)return function(n,o){o.setHeader("Content-Type","text/javascript"),o.end(t[e])}};var _serveFileCount=0;BrowserSync.prototype.serveFile=function(e,t){this.options.get("mode");var n={handle:function(e,n){n.setHeader("Content-Type",t.type),n.end(t.content)},id:"Browsersync - "+_serveFileCount++,route:e};this._addMiddlewareToStack(n)},BrowserSync.prototype._addMiddlewareToStack=function(e){this.app.stack.splice(this.app.stack.length-1,0,e)};var _addMiddlewareCount=0;BrowserSync.prototype.addMiddleware=function(e,t,n){var o=this;if(o.app){(n=n||{}).id||(n.id="bs-mw-"+_addMiddlewareCount++),"*"===e&&(e="");var r={id:n.id,route:e,handle:t};n.override&&(r.override=!0),o.options=o.options.update("middleware",(function(e){return"proxy"===o.options.get("mode")?e.insert(e.size-1,r):e.concat(r)})),o.resetMiddlewareStack()}},BrowserSync.prototype.removeMiddleware=function(e){var t=this;t.app&&(t.options=t.options.update("middleware",(function(t){return t.filter((function(t){return t.id!==e}))})),t.resetMiddlewareStack())},BrowserSync.prototype.getSocketConnector=function(e){var t=this;return function(n,o){o.setHeader("Content-Type","text/javascript"),o.end(t.getExternalSocketConnector(e))}},BrowserSync.prototype.getExternalSocketConnector=function(e){var t=this;return connectUtils.socketConnector(t.options.withMutations((function(n){n.set("socket",n.get("socket").merge(e)),t.options.getIn(["proxy","ws"])||n.set("mode","snippet")})))},BrowserSync.prototype.getOption=function(e){return this.debug("Getting option: {magenta:%s",e),this.options.get(e)},BrowserSync.prototype.getOptionIn=function(e){return this.debug("Getting option via path: {magenta:%s",e),this.options.getIn(e)},BrowserSync.prototype.getOptions=function(){return this.options},BrowserSync.prototype.getLogger=logger.getLogger,BrowserSync.prototype.setOption=function(e,t,n){var o=this;return n=n||{},o.debug("Setting Option: {cyan:%s} - {magenta:%s",e,t.toString()),o.options=o.options.set(e,t),n.silent||o.events.emit("options:set",{path:e,value:t,options:o.options}),this.options},BrowserSync.prototype.setOptionIn=function(e,t,n){var o=this;return n=n||{},o.debug("Setting Option: {cyan:%s} - {magenta:%s",e.join("."),t.toString()),o.options=o.options.setIn(e,t),n.silent||o.events.emit("options:set",{path:e,value:t,options:o.options}),o.options},BrowserSync.prototype.setMany=function(e,t){var n=this;return t=t||{},n.debug("Setting multiple Options"),n.options=n.options.withMutations(e),t.silent||n.events.emit("options:set",{options:n.options.toJS()}),this.options},BrowserSync.prototype.addRewriteRule=function(e){var t=this;t.options=t.options.update("rewriteRules",(function(t){return t.concat(e)})),t.resetMiddlewareStack()},BrowserSync.prototype.removeRewriteRule=function(e){var t=this;t.options=t.options.update("rewriteRules",(function(t){return t.filter((function(t){return t.id!==e}))})),t.resetMiddlewareStack()},BrowserSync.prototype.setRewriteRules=function(e){var t=this;t.options=t.options.update("rewriteRules",(function(t){return e})),t.resetMiddlewareStack()},BrowserSync.prototype.resetMiddlewareStack=function(){var e=this,t=require("./server/utils").getMiddlewares(e,e.options);e.app.stack=t},BrowserSync.prototype.registerCleanupTask=function(e){this._cleanupTasks.push(e)},BrowserSync.prototype.cleanup=function(e){var t=this;t.active&&(t.events&&(t.debug("Removing event listeners..."),t.events.removeAllListeners()),t.watchers&&Object.keys(t.watchers).forEach((function(e){t.watchers[e].watchers.forEach((function(e){e.close()}))})),t._cleanupTasks.forEach((function(e){_.isFunction(e)&&e(t)})),t.debug("Setting {magenta:active: false"),t.active=!1,t.paused=!1,t.pluginManager.plugins={},t.pluginManager.pluginOptions={},t.pluginManager.defaultPlugins=defaultPlugins,t._userPlugins=[],t.userPlugins=[],t._reloadTimer=void 0,t._reloadQueue=[],t._cleanupTasks=[],_.isFunction(e)&&e(null,t))},module.exports=BrowserSync;
//# sourceMappingURL=/sm/a6658f6d3be557bba395113c580c8328a83fb79962827df3027111977391fbaf.map