/**
 * Minified by jsDelivr using Terser v5.10.0.
 * Original file: /npm/browser-sync@2.27.9/dist/server/utils.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
"use strict";var fs=require("fs"),path=require("path"),join=require("path").join,connect=require("connect"),Immutable=require("immutable"),http=require("http"),https=require("https"),Map=require("immutable").Map,fromJS=require("immutable").fromJS,List=require("immutable").List,snippet=require("./../snippet").utils,_=require("../lodash.custom"),serveStatic=require("./serve-static-wrapper").default(),serveIndex=require("serve-index"),logger=require("../logger"),snippetUtils=require("../snippet").utils,lrSnippet=require("resp-modifier"),certPath=join(__dirname,"..","..","certs");function getCa(e){var t=e.getIn(["https","ca"]);return void 0===t?fs.readFileSync(join(certPath,"server.csr")):"string"==typeof t?fs.readFileSync(t):List.isList(t)?t.toArray().map((function(e){return fs.readFileSync(e)})):void 0}function getKey(e){return fs.readFileSync(e.getIn(["https","key"])||join(certPath,"server.key"))}function getCert(e){return fs.readFileSync(e.getIn(["https","cert"])||join(certPath,"server.crt"))}function getHttpsServerDefaults(e){return fromJS({key:getKey(e),cert:getCert(e),ca:getCa(e),passphrase:e.getIn(["https","passphrase"],"")})}function getPFXDefaults(e){return fromJS({pfx:fs.readFileSync(e.getIn(["https","pfx"]))})}var serverUtils={getHttpsOptions:function(e){var t=e.get("https");return Map.isMap(t)?t.has("pfx")?t.mergeDeep(getPFXDefaults(e)):t.mergeDeep(getHttpsServerDefaults(e)):getHttpsServerDefaults(e)},getServer:function(e,t){return{server:function(){var r=serverUtils.getHttpModule(t);if("https"===t.get("scheme")||"http2"===t.get("httpModule")){var i=serverUtils.getHttpsOptions(t);return r.createServer(i.toJS(),e)}return r.createServer(e)}(),app:e}},getHttpModule:function(e){var t=e.get("httpModule");if("string"==typeof t){var r=require.resolve(t);return require(r)}return"https"===e.get("scheme")?https:http},getMiddlewares:function(e){var t=e.pluginManager.hook("client:js",{port:e.options.get("port"),options:e.options}),r=e.pluginManager.get("client:script")(e.options.toJS(),t,"middleware"),i=[{id:"Browsersync HTTP Protocol",route:require("../config").httpProtocol.path,handle:require("../http-protocol").middleware(e)},{id:"Browsersync IE8 Support",route:"",handle:snippet.isOldIe(e.options.get("excludedFileTypes").toJS())},{id:"Browsersync Response Modifier",route:"",handle:serverUtils.getSnippetMiddleware(e)},{id:"Browsersync Client - versioned",route:e.options.getIn(["scriptPaths","versioned"]),handle:r},{id:"Browsersync Client",route:e.options.getIn(["scriptPaths","path"]),handle:r}];if(e.options.get("cors")&&i.unshift({id:"Browsersync CORS support",route:"",handle:serverUtils.getCorsMiddlewware()}),e.options.get("single")&&i.unshift({id:"Browsersync SPA support",route:"",handle:require("connect-history-api-fallback")()}),e.options.get("serveStatic")){var n=serverUtils.getServeStaticMiddlewares(e.options.get("serveStatic"),e.options.get("serveStaticOptions",Immutable.Map({})).toJS()),s=n.filter((function(e){return e.get("errors").size>0})),o=n.filter((function(e){return 0===e.get("errors").size}));s.size&&s.forEach((function(e){logger.logger.error("{red:Warning!} %s",e.getIn(["errors",0,"data","message"]))})),o.size&&o.forEach((function(e){i.push.apply(i,e.get("items").toJS())}))}var p=e.options.get("middleware").map((function(e){if(Map.isMap(e))return e.toJS();if("function"==typeof e)return{route:"",handle:e};if(void 0!==e.route&&e.handle)return e})).toArray(),a=p.filter((function(e){return e.override})),u=p.filter((function(e){return!e.override})).concat("proxy"!==e.options.get("mode")&&0===p.length&&{id:"Browsersync 404/index support",route:"",handle:serveIndex(e.options.get("cwd"),{icons:!0,view:"details"})});return[].concat(a,i,u).filter(Boolean)},getBaseApp:function(e){var t=connect();return serverUtils.getMiddlewares(e).forEach((function(e){t.stack.push(e)})),t},getSnippetMiddleware:function(e){var t=[],r=List([]).concat(e.options.getIn(["snippetOptions","ignorePaths"])).concat(e.options.getIn(["snippetOptions","blacklist"])).filter(Boolean),i=List([]).concat(e.options.getIn(["snippetOptions","whitelist"]));if(e.options.get("snippet")&&t.push(snippetUtils.getRegex(e.options.get("snippet"),e.options.get("snippetOptions"))),e.options.get("rewriteRules").forEach((function(e){Map.isMap(e)&&t.push(e.toJS()),_.isPlainObject(e)&&t.push(e)})),e.options.get("proxy")){var n=require("./proxy-utils").rewriteLinks(e.options.getIn(["proxy","url"]).toJS());t.push(n)}return lrSnippet.create({rules:t,blacklist:r.toArray(),whitelist:i.toArray()}).middleware},getCorsMiddlewware:function(){return function(e,t,r){t.setHeader("Access-Control-Allow-Origin","*"),t.setHeader("Access-Control-Allow-Methods","GET, POST, OPTIONS, PUT, PATCH, DELETE"),t.setHeader("Access-Control-Allow-Headers","X-Requested-With,content-type"),t.setHeader("Access-Control-Allow-Credentials",!0),r()}},getServeStaticMiddlewares:function(e,t){return e.map((function(e,i){return _.isString(e)?function(e){return fromJS({items:[{route:"",handle:serveStatic(e,t)}],errors:[]})}(e):Immutable.Map.isMap(e)?function(e){var t=e.get("options")?e.get("options").toJS():{},i=Immutable.List([]).concat(e.get("route")).filter(_.isString),n=Immutable.List([]).concat(e.get("dir")).filter(_.isString);if(0===n.size)return fromJS({items:[],errors:[{type:"Invalid Object",data:{message:"Serve Static requires a 'dir' property when using an Object"}}]});var s=(0===i.size?n.map((function(e){return Map({route:"",dir:e})})):i.reduce((function(e,t){var i=n.map((function(e){return Map({route:r(t),dir:e})}));return e.concat(i)}),List([]))).map((function(e){return e.merge({handle:serveStatic(e.get("dir"),t)})}));return fromJS({items:s,errors:[]})}(e):fromJS({items:[],errors:[{type:"Invalid Type",data:{message:"Only strings and Objects (with route+dir) are supported for the ServeStatic option"}}]})}));function r(e){return""===e?"":"/"===e[0]?e:"/"+e}}};module.exports=serverUtils;
//# sourceMappingURL=/sm/00c6cf27fefb500cefd230b4392f18a721e49da5266f41413ab72919c55c5ed0.map